# SmartAgent2 功能升级说明

## 概述

本次升级为 SmartAgent2 车载记忆系统增加了两个核心功能：

1. **偏好编辑功能** - 允许用户在界面上直接修改、添加和删除偏好设置
2. **真实 LLM 后端** - 接入字节跳动 Ark API，实现基于用户画像和记忆的智能对话

## 一、偏好编辑功能

### 功能入口

在右侧"用户画像"标签页中，"偏好设置"标题旁有一个"编辑"按钮，点击即可打开偏好编辑对话框。

### 功能特性

**编辑现有偏好**：可以修改任何现有偏好的分类、偏好项名称和偏好值。例如，将"喜欢的歌手"从"周杰伦、五月天"改为"林俊杰、陈奕迅"。

**添加新偏好**：在对话框底部的"添加新偏好"区域，选择分类、填写偏好项和偏好值，点击"添加"按钮即可创建新的偏好记录。

**删除偏好**：每条偏好记录右侧都有删除按钮，点击即可移除该偏好。

**支持的分类**：音乐、空调、座椅、导航、饮食、其他

### 使用示例

**场景 1：更换喜欢的歌手**
- 点击"编辑"按钮
- 找到"音乐/喜欢的歌手"这一项
- 修改偏好值为新的歌手名字
- 点击"保存更改"

**场景 2：调整空调温度**
- 点击"编辑"按钮
- 找到"空调/温度"这一项
- 将温度从 23°C 改为 25°C
- 点击"保存更改"

**场景 3：添加新的导航地址**
- 点击"编辑"按钮
- 在底部"添加新偏好"区域
- 选择分类：导航
- 偏好项：常去健身房
- 偏好值：健身工场（科技园店）
- 点击"添加"按钮
- 点击"保存更改"

## 二、真实 LLM 后端

### 技术架构

系统已从纯前端模拟升级为全栈架构，包含以下组件：

**后端 API 服务**：基于 Express.js 的 RESTful API，提供对话、用户画像、记忆管理等接口。

**LLM 调用模块**：集成字节跳动 Ark API，使用 DeepSeek 模型进行智能对话生成。

**数据存储模块**：内存数据库，存储用户画像、偏好设置和情景记忆。

### LLM 配置信息

- **API 提供商**：字节跳动 Ark
- **模型**：DeepSeek (ep-20250811200411-zctsd)
- **API Key**：7c4d52bf-e540-4337-a9ab-1a5228acedaa
- **端点**：https://ark.cn-beijing.volces.com/api/v3

### 智能对话特性

**基于用户画像的个性化回复**：LLM 会根据用户的基本信息、偏好设置和家庭关系，生成个性化的回复内容。

**基于情景记忆的上下文理解**：系统会检索相关的历史记忆，帮助 LLM 理解用户的上下文和历史行为。

**多种 AI 人格支持**：支持切换不同的 AI 人格（小智、贾维斯、阿尔弗雷德），每种人格有不同的对话风格。

**降级策略**：当 LLM API 调用失败时，系统会自动降级到规则基础的简单回复，确保服务可用性。

### 对话示例

**示例 1：音乐推荐**
- 用户："放点我喜欢的音乐吧"
- AI："好的，根据您的偏好，为您播放周杰伦的《晴天》和五月天的《倔强》。"

**示例 2：空调调节**
- 用户："按照我的习惯调整空调"
- AI："已为您将空调设置为 23°C，中风模式，自动运行。"

**示例 3：导航规划**
- 用户："导航去上班"
- AI："正在为您规划前往科技园 A 座 18 楼的路线，预计行驶时间 25 分钟。"

**示例 4：家庭关怀**
- 用户："带妈妈出门要注意些什么？"
- AI："您妈妈膝盖不太好，有轻微关节炎，建议选择无障碍通道，避免长时间步行。可以考虑去她喜欢的翠苑小区附近活动。"

## 三、API 端点说明

### 对话接口
```
POST /api/v1/chat
```
请求体示例：
```json
{
  "user_id": "zhangming",
  "session_id": "sess_1234567890",
  "message": "放点我喜欢的音乐吧",
  "options": {
    "include_memory": true,
    "include_profile": true,
    "character_id": "default"
  }
}
```

### 用户画像接口
```
GET /api/v1/profile/:userId
PUT /api/v1/profile/:userId
```

### 记忆接口
```
GET /api/v1/memory/stats/:userId
GET /api/v1/memory/episodic?user_id=zhangming
```

### AI 人格接口
```
GET /api/v1/character/
GET /api/v1/character/:characterId
```

### 用户角色接口
```
GET /api/v1/user/roles
```

## 四、测试方法

### 前端测试

访问部署地址：https://3000-i9w3nyw23y40snraquh4k-1380de81.sg1.manus.computer

1. 在对话框中输入消息，测试 AI 回复
2. 切换不同用户角色，观察个性化差异
3. 点击右侧"编辑"按钮，测试偏好编辑功能
4. 查看"情景记忆"和"关系网络"标签页

### API 测试

使用 curl 命令测试后端 API：

```bash
# 测试对话接口
curl -X POST http://localhost:3000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "zhangming",
    "session_id": "test123",
    "message": "你好",
    "options": {
      "include_memory": true,
      "include_profile": true
    }
  }'

# 测试用户画像接口
curl http://localhost:3000/api/v1/profile/zhangming
```

## 五、已知限制与注意事项

**数据持久化**：当前使用内存数据库，服务器重启后数据会重置。生产环境建议接入 MySQL 或 MongoDB。

**LLM API 限制**：字节跳动 Ark API 可能有调用频率和配额限制，超出限制时会触发降级策略。

**网络依赖**：LLM 调用需要访问外部 API，网络不稳定可能导致响应延迟或失败。

**前端兼容性**：建议使用现代浏览器（Chrome、Firefox、Safari 最新版本）访问。

## 六、后续优化方向

**数据库集成**：接入 MySQL 或 MongoDB，实现数据持久化存储。

**用户认证**：添加登录功能，支持多租户和权限管理。

**记忆增强**：实现自动记忆提取和更新机制，减少手动维护。

**对话优化**：优化 LLM 提示词工程，提升对话质量和准确性。

**性能优化**：添加缓存机制，减少 LLM API 调用次数。

**移动端适配**：优化响应式布局，支持手机和平板设备。

## 七、技术支持

如有问题或建议，请查看项目文档或联系开发团队。

- 项目地址：https://github.com/yangli0403/SmartAgent2/tree/web-frontend
- 测试结果：见 TEST_RESULTS.md
- 部署地址：https://3000-i9w3nyw23y40snraquh4k-1380de81.sg1.manus.computer
